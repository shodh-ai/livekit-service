name: Deploy livekit-service to Cloud Run Service

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  PROJECT_ID: first-cedar-470107-j2
  SERVICE_NAME: livekit-service
  IMAGE_NAME: livekit-agent-worker
  REGION: asia-south1  # Update if your job is in a different region
  REGISTRY: asia-south1-docker.pkg.dev
  REPOSITORY: livekit-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        # Alternative: use workload identity federation (recommended)
        # workload_identity_provider: projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider
        # service_account: my-service-account@my-project.iam.gserviceaccount.com

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker asia-south1-docker.pkg.dev

    - name: Build Docker image
      run: |
        docker build -t $REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:$GITHUB_SHA .
        docker tag $REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:$GITHUB_SHA $REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:latest

    - name: Push Docker image to registry
      run: |
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:$GITHUB_SHA
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:latest

    - name: Deploy Cloud Run Service
      run: |
        gcloud run deploy $SERVICE_NAME \
          --image=$REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:$GITHUB_SHA \
          --region=$REGION \
          --platform=managed \
          --no-allow-unauthenticated \
          --project=$PROJECT_ID \
          --update-secrets="LIVEKIT_API_KEY=LIVEKIT_API_KEY:latest,LIVEKIT_API_SECRET=LIVEKIT_API_SECRET:latest,LIVEKIT_URL=LIVEKIT_URL:latest,DEEPGRAM_API_KEY=DEEPGRAM_API_KEY:latest,GOOGLE_API_KEY=GOOGLE_API_KEY:latest,LANGGRAPH_TUTOR_URL=LANGGRAPH_TUTOR_URL:latest,OTEL_SERVICE_NAME=OTEL_SERVICE_NAME_LIVEKIT:latest,OTEL_EXPORTER_OTLP_PROTOCOL=OTEL_EXPORTER_OTLP_PROTOCOL:latest,GRAFANA_OTLP_HTTP_ENDPOINT=GRAFANA_OTLP_HTTP_ENDPOINT:latest,GRAFANA_OTLP_HEADERS=GRAFANA_OTLP_HEADERS:latest,OTEL_RESOURCE_ATTRIBUTES=OTEL_RESOURCE_ATTRIBUTES:latest,ENABLE_TURN_DETECTION=ENABLE_TURN_DETECTION:latest,TURN_DETECTION_MODEL=TURN_DETECTION_MODEL:latest,TURN_UNLIKELY_THRESHOLD=TURN_UNLIKELY_THRESHOLD:latest"
