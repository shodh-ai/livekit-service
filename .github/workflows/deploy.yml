name: Deploy LiveKit Services

on:
  push:
    branches:
      - main       # PRODUCTION
      - develop    # STAGING

env:
  PROJECT_ID: first-cedar-470107-j2
  REGION: asia-south1
  CLUSTER_NAME: autopilot-cluster-1
  GAR_REPO: asia-south1-docker.pkg.dev/first-cedar-470107-j2/session-bubble

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: pytest -q

  deploy:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Set Environment (prod vs staging)
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Deploying to PRODUCTION"
            echo "NAMESPACE=default" >> $GITHUB_ENV
          else
            echo "Deploying to STAGING"
            echo "NAMESPACE=staging" >> $GITHUB_ENV
          fi

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # Build once: image contains the worker entrypoint used by rox-agent-pool
      - name: Build and Push Image
        run: |
          IMAGE_TAG="${GITHUB_SHA}"
          FULL_IMAGE_NAME="${{ env.GAR_REPO }}/rox-agent:${IMAGE_TAG}"
          echo "Building image: $FULL_IMAGE_NAME"
          docker build -t "$FULL_IMAGE_NAME" .
          docker push "$FULL_IMAGE_NAME"
          echo "IMAGE_URI=$FULL_IMAGE_NAME" >> $GITHUB_ENV

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          location: ${{ env.REGION }}

      - name: Update rox-agent-pool Deployment image
        run: |
          kubectl set image deployment/rox-agent-pool agent=${IMAGE_URI} -n $NAMESPACE
          kubectl rollout status deployment/rox-agent-pool -n $NAMESPACE
